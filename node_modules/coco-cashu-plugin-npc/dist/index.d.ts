import { JWTAuthProvider, NPCClient, PaymentRequiredError } from "npubcash-sdk";
import { Logger, PaymentRequestService, Plugin, PluginContext } from "coco-cashu-core";
import * as npubcash_types0 from "npubcash-types";

//#region src/sync/sinceStore.d.ts

/**
 * Interface for persisting the last processed timestamp.
 *
 * Implementations should store the timestamp durably to allow
 * resuming sync operations after restarts.
 */
interface SinceStore {
  /**
   * Retrieves the last processed timestamp.
   * @returns The timestamp in milliseconds, or 0 if never set
   */
  get(): Promise<number>;
  /**
   * Stores the last processed timestamp.
   * @param since - The timestamp in milliseconds
   */
  set(since: number): Promise<void>;
}
/**
 * In-memory implementation of SinceStore.
 *
 * Note: State is lost on restart. Use a database-backed
 * implementation for production use cases that require durability.
 *
 * @example
 * ```typescript
 * const store = new MemorySinceStore(0);
 * await store.set(Date.now());
 * const since = await store.get(); // Returns the stored timestamp
 * ```
 */
declare class MemorySinceStore implements SinceStore {
  private since;
  /**
   * Creates a new MemorySinceStore.
   * @param initialSince - Initial timestamp value (default: 0)
   */
  constructor(initialSince?: number);
  get(): Promise<number>;
  set(since: number): Promise<void>;
}
/**
 * LocalStorage-based implementation of SinceStore.
 *
 * Persists the timestamp to browser localStorage, allowing state
 * to survive page refreshes and browser restarts.
 *
 * Note: Only works in browser environments where localStorage is available.
 * Will throw an error if localStorage is not accessible.
 *
 * @example
 * ```typescript
 * const store = new LocalStorageSinceStore("my-app-npc-since");
 * await store.set(Date.now());
 * const since = await store.get(); // Returns the stored timestamp
 * ```
 */
declare class LocalStorageSinceStore implements SinceStore {
  private readonly key;
  private readonly fallbackValue;
  /**
   * Creates a new LocalStorageSinceStore.
   * @param key - The localStorage key to use for storing the timestamp
   * @param fallbackValue - Value to return if no timestamp is stored (default: 0)
   * @throws {Error} If localStorage is not available
   */
  constructor(key: string, fallbackValue?: number);
  get(): Promise<number>;
  set(since: number): Promise<void>;
  /**
   * Removes the stored timestamp from localStorage.
   */
  clear(): Promise<void>;
}
//#endregion
//#region src/types.d.ts
/**
 * Quote data returned from NPubCash API
 */
interface NPCQuote {
  quoteId: string;
  mintUrl: string;
  amount: number;
  expiresAt: number;
  paidAt: number;
  request?: string;
  /** Additional properties from the API */
  [key: string]: unknown;
}
/**
 * Transformed quote ready for mint quote service
 */
interface MintQuote {
  quoteId: string;
  mintUrl: string;
  amount: number;
  expiry: number;
  paidAt: number;
  unit: string;
  state: string;
  quote: string;
  request: string;
  [key: string]: unknown;
}
/**
 * Signer type for JWT authentication.
 * This is intentionally typed as `unknown` to allow compatibility
 * with various signing implementations from npubcash-sdk.
 */
type Signer = ConstructorParameters<typeof JWTAuthProvider>[1];
/**
 * Extended logger interface that supports structured logging
 */
interface StructuredLogger extends Logger {
  child?(bindings: Record<string, unknown>): StructuredLogger;
}
/**
 * Creates a child logger if the logger supports it, otherwise returns the original
 */
declare function createChildLogger(logger: StructuredLogger | undefined, bindings: Record<string, unknown>): StructuredLogger | undefined;
/**
 * Formats a log message with optional context data
 */
declare function formatLogMessage(message: string, data?: Record<string, unknown>): string;
/**
 * Default values for quote transformation
 */
declare const QUOTE_DEFAULTS: {
  readonly UNIT: "sat";
  readonly STATE_PAID: "PAID";
};
/**
 * Validates that a quote has required fields
 */
declare function isValidQuote(quote: unknown): quote is NPCQuote;
/**
 * Validates that a string is a valid URL
 */
declare function isValidUrl(url: string): boolean;
//#endregion
//#region src/plugins/NPCPlugin.d.ts
declare const requiredServices: readonly ["mintQuoteService", "mintService", "paymentRequestService"];
/**
 * Configuration options for NPCPlugin
 */
interface NPCPluginOptions {
  /**
   * Interval in milliseconds between sync operations.
   * If not provided, interval-based syncing is disabled.
   */
  syncIntervalMs?: number;
  /**
   * Enable WebSocket subscription for real-time updates.
   * When enabled, the plugin will receive push notifications for new quotes.
   * @default false
   */
  useWebsocket?: boolean;
  /**
   * Custom store for persisting the last processed timestamp.
   * Defaults to in-memory storage (state lost on restart).
   */
  sinceStore?: SinceStore;
  /**
   * Logger instance for debugging and error reporting.
   * If the logger has a `child` method, it will be used to create
   * a child logger with module context.
   */
  logger?: Logger;
}
/**
 * Plugin status information
 */
interface NPCPluginStatus {
  /** Whether the plugin has been initialized */
  isInitialized: boolean;
  /** Whether the plugin is ready to sync */
  isReady: boolean;
  /** Whether a sync operation is currently running */
  isSyncing: boolean;
  /** Whether WebSocket is connected */
  isWebSocketConnected: boolean;
}
/**
 * NPubCash plugin for coco-cashu-core.
 *
 * This plugin bridges an NPubCash server with the coco-cashu wallet,
 * polling for newly paid quotes and forwarding them to the mint quote service.
 */
declare class NPCPlugin implements Plugin<typeof requiredServices> {
  readonly name = "npc";
  readonly required: readonly ["mintQuoteService", "mintService", "paymentRequestService"];
  private readonly npcClient;
  private readonly sinceStore;
  private readonly logger?;
  private readonly intervalMs?;
  private readonly useWebsocket;
  private isRunning;
  private hasPendingUpdate;
  private runPromise?;
  private unsubscribe?;
  private intervalTimer?;
  private isReady;
  private isWebSocketConnected;
  private wsReconnectAttempts;
  private wsReconnectTimer?;
  private ctx?;
  private isShuttingDown;
  /**
   * Creates a new NPCPlugin instance.
   *
   * @param baseUrl - The base URL of the NPubCash server
   * @param signer - Signer instance for JWT authentication
   * @param options - Plugin configuration options
   * @throws {Error} If baseUrl is not a valid URL
   */
  constructor(baseUrl: string, signer: Signer, options?: NPCPluginOptions);
  /**
   * Returns the current status of the plugin.
   */
  getStatus(): NPCPluginStatus;
  /**
   * Called by coco-cashu-core during plugin initialization.
   * @internal
   */
  onInit(ctx: PluginContext<typeof requiredServices>): () => Promise<void>;
  /**
   * Called by coco-cashu-core when the host is ready.
   * @internal
   */
  onReady(): void;
  /**
   * Manually triggers a sync operation.
   * If a sync is already in progress, returns the existing promise.
   *
   * @returns Promise that resolves when the sync completes
   */
  sync(): Promise<void>;
  /**
   * Gracefully shuts down the plugin.
   * Waits for any in-flight sync operations to complete.
   */
  shutdown(): Promise<void>;
  private teardown;
  private connectWebSocket;
  private scheduleWebSocketReconnect;
  private armIntervalTimer;
  private requestSync;
  private startRunner;
  private syncPaidQuotesOnce;
}
//#endregion
//#region src/PluginApi.d.ts
type SetUsernameResult = {
  success: true;
} | {
  success: false;
  pr: Omit<PaymentRequiredError["paymentRequest"], "nut26">;
  acceptHandler: () => Promise<void>;
};
declare class PluginApi {
  private prService;
  private client;
  constructor(prService: PaymentRequestService, client: NPCClient);
  getInfo(): Promise<npubcash_types0.User>;
  setUsername(username: string): Promise<SetUsernameResult>;
}
//#endregion
//#region src/index.d.ts
declare module "coco-cashu-core" {
  interface PluginExtensions {
    npc: PluginApi;
  }
}
//#endregion
export { LocalStorageSinceStore, MemorySinceStore, MintQuote, NPCPlugin, NPCPluginOptions, NPCPluginStatus, NPCQuote, PluginApi, QUOTE_DEFAULTS, SetUsernameResult, Signer, SinceStore, StructuredLogger, createChildLogger, formatLogMessage, isValidQuote, isValidUrl };